<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
   <head>
      <title>4.1. Methods and Annotations</title>
      <link rel="stylesheet" href="css/jbossorg.css" type="text/css"/>
      <meta name="generator" content="DocBook XSL Stylesheets V1.72.0"/>
      <link rel="start" href="index.html" title="JBoss AOP - User Guide"/>
      <link rel="up" href="annotations.html" title="Chapter 4. Aspect-Oriented Annotations"/>
      <link rel="prev" href="annotations.html" title="Chapter 4. Aspect-Oriented Annotations"/>
      <link rel="next" href="annotations2.html" title="4.2. Fields and Annotations"/>
   </head>
   <body>
      <p id="title">
         <a href="http://www.jboss.org" class="jbossOrg_href">
            <strong>
						        JBoss.org	
						</strong>
         </a>
         <a href="http://labs.jboss.com/projects/docs" class="commDoc_href">
            <strong>
						        Community Documentation	
						</strong>
         </a>
      </p>
      <ul class="docnav">
         <li class="previous">
            <a accesskey="p" href="annotations.html">
               <strong>Prev</strong>
            </a>
         </li>
         <li class="next">
            <a accesskey="n" href="annotations2.html">
               <strong>Next</strong>
            </a>
         </li>
      </ul>
      <div class="sect1" lang="en">
         <div class="titlepage">
            <div>
               <div>
                  <h2 class="title">
                     <a id="annotations1"/>4.1. Methods and Annotations</h2>
               </div>
            </div>
         </div>
         <p>
         Let's take a look at how you can use method annotations with AOP. Using annotations and AOP together and
         applying this to a method is very analogous to using Java's synchronized keyword with a method. When you tag
         a method as synchronized, you are telling the JVM that you want that method to behave in a special way when it
         is invoked. Annotations allow you to define new keywords that you want to have trigger your own special custom
         behavior. AOP gives you the ability to encapsulate this behavior and weave it into the execution of the method.
      </p>
         <p>
         Let's say we want to add a new syntax that will allow us to fire <code class="literal">void</code> methods in the
         background, in another
         thread, if they are tagged as <code class="literal">@Oneway</code>. Using this new syntax would look like this:
      </p>
         <pre class="programlisting">import org.jboss.aspects.Oneway;

public class Foo
{
   @Oneway public static void someMethod() {...}

   public static void main(String[] args)
   {
      someMethod(); // executes in background
   }
}</pre>
         <p>
         When <code class="literal">someMethod()</code> is invoked within main, it will run asynchronously so that the code in main is free to do
         ther tasks in parallel.
      </p>
         <p>
         To implement this functionality, the first thing that must be done is to define the new Java syntax for our
         <code class="literal">@Oneway</code> tag within an annotation.
      </p>
         <pre class="programlisting">
package org.jboss.aspects;

import java.lang.annotation.ElementType;
import java.lang.annotation.Target;

@Target({ElementType.METHOD})
public @interface Oneway {}
      </pre>
         <p>
         Simple enough. The <code class="literal">@Target</code> tag allows you to narrow down where the annotation is allowed to
         be applied. In this case, our @Oneway annotation can only be applied to a method. Remember, this is all pure
         100 percent Java that is available in J2SE 5.0.
      </p>
         <p>
         The next thing we have to do is to define an aspect class that will encapsulate our <code class="literal">@Oneway</code>
         behavior.
      </p>
         <pre class="programlisting">
package org.jboss.aspects;

public OnewayAspect
{
   private static class Task implements Runnable
   {
      private MethodInvocation invocation;

      public Task(MethodInvocation invocation)
      {
        this.invocation = invocation;
      }
      public void run()
      {
        try { invocation.invokeNext(); }
        catch (Throwable ignore) { }
      }
   }


   public Object oneway(MethodInvocation invocation) throws Throwable
   {
      MethodInvocation copy = invocation.copy();
      Thread t = new Thread(new Task(copy));
      t.setDaemon(false);
      t.start();
      return null;
   }
}
         </pre>
         <p>
         The aspect is simple enough. The oneway() method copies the invocation, creates a thread, fires off the complete
         invocation in the background, and returns. We could imagine a more sophisticated example using some of the new
         Executors within the J2SE 5.0 java.util.concurrent package, but hopefully this code illustrates how you could
         build on this example to implement more complete implementations.
      </p>
         <p>
         The last thing that must be done is to specify the pointcut expression that will trigger the application of the
         <code class="literal">OnewayAspect</code> when the <code class="literal">@Oneway</code> annotation is declared on a method.
      </p>
         <pre class="programlisting">
&lt;aop&gt;
   &lt;aspect class="org.jboss.aspects.OnewayAspect"/&gt;

   &lt;bind pointcut="execution(void *-&gt;@org.jboss.Oneway(..))"&gt;
      &lt;advice name="oneway"
              aspect="org.jboss.aspects.OnewayAspect"/&gt;
   &lt;/bind&gt;
&lt;/aop&gt;</pre>
         <p>
         The pointcut expression states that any void method that is tagged as <code class="literal">@Oneway</code> should have
         the <code class="literal">OnewayAspect.oneway()</code> method executed before it itself executes. With the annotation,
         aspect, and pointcut expression now defined, the @Oneway syntax is now usable in your application. A simple,
         clean, easy way of extending the Java language!
      </p>
      </div>
      <ul class="docnav">
         <li class="previous">
            <a accesskey="p" href="annotations.html">
               <strong>Prev</strong>Chapter 4. Aspect-Oriented Annotations</a>
         </li>
         <li class="up">
            <a accesskey="u" href="#">
               <strong>Top of page</strong>
            </a>
         </li>
         <li class="home">
            <a accesskey="h" href="index.html">
               <strong>Front page</strong>
            </a>
         </li>
         <li class="next">
            <a accesskey="n" href="annotations2.html">
               <strong>Next</strong>4.2. Fields and Annotations</a>
         </li>
      </ul>
   </body>
</html>