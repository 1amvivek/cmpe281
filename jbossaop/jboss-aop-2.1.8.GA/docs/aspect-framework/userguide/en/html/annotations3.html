<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
   <head>
      <title>4.3. Dependency Injection</title>
      <link rel="stylesheet" href="css/jbossorg.css" type="text/css"/>
      <meta name="generator" content="DocBook XSL Stylesheets V1.72.0"/>
      <link rel="start" href="index.html" title="JBoss AOP - User Guide"/>
      <link rel="up" href="annotations.html" title="Chapter 4. Aspect-Oriented Annotations"/>
      <link rel="prev" href="annotations2.html" title="4.2. Fields and Annotations"/>
      <link rel="next" href="introductions.html" title="Chapter 5. Mixins and Introductions"/>
   </head>
   <body>
      <p id="title">
         <a href="http://www.jboss.org" class="jbossOrg_href">
            <strong>
						        JBoss.org	
						</strong>
         </a>
         <a href="http://labs.jboss.com/projects/docs" class="commDoc_href">
            <strong>
						        Community Documentation	
						</strong>
         </a>
      </p>
      <ul class="docnav">
         <li class="previous">
            <a accesskey="p" href="annotations2.html">
               <strong>Prev</strong>
            </a>
         </li>
         <li class="next">
            <a accesskey="n" href="introductions.html">
               <strong>Next</strong>
            </a>
         </li>
      </ul>
      <div class="sect1" lang="en">
         <div class="titlepage">
            <div>
               <div>
                  <h2 class="title">
                     <a id="annotations3"/>4.3. Dependency Injection</h2>
               </div>
            </div>
         </div>
         <p>
         Another interesting place where field annotations and AOP can be used is with dependency injection. Dependency
         injection is about objects declaring what information, configuration, or service references they need, and
         having the runtime automagically inject those dependencies rather than having your code do explicit lookups on
         a registry service. In J2EE-land, getting access to a javax.transaction.TransactionManager service is not
         standardized and is actually different per vendor implementation. Many framework developers need to use the
         TransactionManager to implement custom transactional services. The use of AOP with field annotations is a great
         way to provide this dependency injection and to abstract away the details of how a TransactionManager is
         referenced by components that need it. Let's define an aspect that will inject a reference to a
         TransactionManager into the value of a field.
      </p>
         <p>
         First, we must again define our annotation.
      </p>
         <pre class="programlisting">
package org.jboss.aspects;

import java.lang.annotation.ElementType;
import java.lang.annotation.Target;

@Target({ElementType.FIELD})
public @interface Inject {}</pre>
         <p>
         Next we will define the aspect class that will encapsulate the resolving of the TransactionManager. This aspect
         will be specific to the JBoss application server, but you could define different implementations per vendor.
      </p>
         <pre class="programlisting">package org.jboss.aspects;

import org.jboss.aop.joinpoint.*;
import java.lang.reflect.Field;
import javax.transaction.TransactionManager;
import org.jboss.tm.TxManager;

public InjectTMAspect
{
   private TransactionManager tm = TxManager.getInstance();

   public Object access(FieldReadInvocation invocation)
       throws Throwable
   {
      return tm;
   }

   public Object access(FieldWriteInvocation invocation)
       throws Throwable
   {
      throw new RuntimeException(
          "Setting an @Injected variable is illegal");
   }
}</pre>
         <p>
           Finally, we have to define the XML binding that will trigger the application of the InjectTMAspect when the
           @Inject tag is applied to a field. The pointcut expression basically states that for any field of type
           TransactionManager and tagged as @Inject, apply the InjectTMAspect.
        </p>
         <pre class="programlisting">&lt;aop&gt;
  &lt;aspect class="org.jboss.aspects.InjectTMAspect"/&gt;

  &lt;bind pointcut="field(javax.transaction.TransactionManager *-&gt;@org.jboss.aspects.Inject)"&gt;
     &lt;advice name="access"
             aspect="org.jboss.aspects.InjectTMAspect"/&gt;
  &lt;/bind&gt;
&lt;/aop&gt;</pre>
         <p>
           Now that the annotation, aspect class, and XML binding have been defined, we can use it within our code.
        </p>
         <pre class="programlisting">import javax.transaction.TransactionManager;
import org.jboss.aspects.Inject;

public class MyTransactionalCache
{
   @Inject private TransactionManager tm;
...
}</pre>
      </div>
      <ul class="docnav">
         <li class="previous">
            <a accesskey="p" href="annotations2.html">
               <strong>Prev</strong>4.2. Fields and Annotations</a>
         </li>
         <li class="up">
            <a accesskey="u" href="#">
               <strong>Top of page</strong>
            </a>
         </li>
         <li class="home">
            <a accesskey="h" href="index.html">
               <strong>Front page</strong>
            </a>
         </li>
         <li class="next">
            <a accesskey="n" href="introductions.html">
               <strong>Next</strong>Chapter 5. Mixins and Introductions</a>
         </li>
      </ul>
   </body>
</html>