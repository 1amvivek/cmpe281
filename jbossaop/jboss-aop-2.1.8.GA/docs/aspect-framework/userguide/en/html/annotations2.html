<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
   <head>
      <title>4.2. Fields and Annotations</title>
      <link rel="stylesheet" href="css/jbossorg.css" type="text/css"/>
      <meta name="generator" content="DocBook XSL Stylesheets V1.72.0"/>
      <link rel="start" href="index.html" title="JBoss AOP - User Guide"/>
      <link rel="up" href="annotations.html" title="Chapter 4. Aspect-Oriented Annotations"/>
      <link rel="prev" href="annotations1.html" title="4.1. Methods and Annotations"/>
      <link rel="next" href="annotations3.html" title="4.3. Dependency Injection"/>
   </head>
   <body>
      <p id="title">
         <a href="http://www.jboss.org" class="jbossOrg_href">
            <strong>
						        JBoss.org	
						</strong>
         </a>
         <a href="http://labs.jboss.com/projects/docs" class="commDoc_href">
            <strong>
						        Community Documentation	
						</strong>
         </a>
      </p>
      <ul class="docnav">
         <li class="previous">
            <a accesskey="p" href="annotations1.html">
               <strong>Prev</strong>
            </a>
         </li>
         <li class="next">
            <a accesskey="n" href="annotations3.html">
               <strong>Next</strong>
            </a>
         </li>
      </ul>
      <div class="sect1" lang="en">
         <div class="titlepage">
            <div>
               <div>
                  <h2 class="title">
                     <a id="annotations2"/>4.2. Fields and Annotations</h2>
               </div>
            </div>
         </div>
         <p>
         Let's look at how you could use field annotations and AOP. Using annotations and AOP, you can can actually
         change how a field is stored by an object or as a static member of a class. What we want to accomplish in this
         example is that when you tag a field (static or member) as @ThreadBased, its value will behave as though it
         were stored in a java.lang.ThreadLocal. Sure, you could use a ThreadLocal variable directly, but the problem
         with ThreadLocal is that it is untyped and you have to use "verbose" (okay, they're not that verbose) get()
         and set() methods. So what we'll do here is create a typed ThreadLocal field. Basically, we'll create a new
         Java field type called the @Threadbased variable.
      </p>
         <p>
         Using this new type would look like this:
      </p>
         <pre class="programlisting">
import org.jboss.aspects.Threadbased;

public class Foo
{
   @Threadbased private int counter;
}</pre>
         <p>
         To implement this functionality, we must first define the annotation.
      </p>
         <pre class="programlisting">
package org.jboss.aspects;

import java.lang.annotation.ElementType;
import java.lang.annotation.Target;

@Target({ElementType.FIELD})
public @interface Threadbased {}
</pre>
         <p>
         Simple enough. The @Target tag allows you to narrow down where the annotation is allowed to be applied. In this
         case, our @Threadbased annotation can only be applied to fields.
      </p>
         <p>
         The next thing to do is to define the aspect that will encapsulate our ThreadLocal behavior.
      </p>
         <pre class="programlisting">
package org.jboss.aspects;

import org.jboss.aop.joinpoint.*;
import java.lang.reflect.Field;

public class ThreadbasedAspect
{
   private ThreadLocal threadbased = new ThreadLocal();

   public Object access(FieldReadInvocation invocation)
       throws Throwable
   {
      // just in case we have a primitive,
      // we can't return null
      if (threadbased.get() == null)
          return invocation.invokeNext();
      return threadbased.get();
   }

   public Object access(FieldWriteInvocation invocation)
       throws Throwable
   {
      threadbased.set(invocation.getValue());
      return null;
   }
}</pre>
         <p>
         ThreadbasedAspect encapsulates the access to a Java field. It has a dedicated ThreadLocal variable within it to
         track threadlocal changes to a particular field. It also has separate access() methods that are invoked
         depending upon whether a get or set of the field is called. These methods delegate to the ThreadLocal to obtain
         the current value of the field.
      </p>
         <p>
         Finally, we must define a pointcut expression that will trigger the application of the ThreadbasedAspect when
         the @Threadbased annotation is specified on a particular field.
      </p>
         <pre class="programlisting">
&lt;aop&gt;
   &lt;aspect class="org.jboss.aspects.ThreadbasedAspect"
           scope="PER_JOINPOINT"/&gt;
   &lt;bind pointcut="field(* *-&gt;@org.jboss.aspects.Threadbased)"&gt;
      &lt;advice name="access"
              aspect="org.jboss.aspects.ThreadbasedAspect"/&gt;
   &lt;/bind&gt;
&lt;/aop&gt;</pre>
         <p>
         Just in case we have multiple @Threadbased variables defined in one class, we want an instance of
         ThreadbasedAspect to be allocated per field for static fields. For member fields, we want an instance of
         ThreadbasedAspect to be allocated per field, per object instance. To facilitate this behavior, the aspect
         definition scopes the instance of when and where the aspect class will be allocated by setting it to
         PER_JOINPOINT. If we didn't do this scoping, JBoss AOP would only allocate one instance of ThreadbasedAspect
         and different fields would be sharing the same instance of the ThreadLocal -- something that we don't want.
      </p>
         <p>
         Well that's it. A clean, easy way of extending Java to specify a new special type. Note: This particular aspect
         comes bundled with JBoss AOP.
      </p>
      </div>
      <ul class="docnav">
         <li class="previous">
            <a accesskey="p" href="annotations1.html">
               <strong>Prev</strong>4.1. Methods and Annotations</a>
         </li>
         <li class="up">
            <a accesskey="u" href="#">
               <strong>Top of page</strong>
            </a>
         </li>
         <li class="home">
            <a accesskey="h" href="index.html">
               <strong>Front page</strong>
            </a>
         </li>
         <li class="next">
            <a accesskey="n" href="annotations3.html">
               <strong>Next</strong>4.3. Dependency Injection</a>
         </li>
      </ul>
   </body>
</html>