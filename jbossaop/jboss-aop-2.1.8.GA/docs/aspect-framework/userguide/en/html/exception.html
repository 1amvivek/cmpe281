<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
   <head>
      <title>8.1. Testing Exception Handling</title>
      <link rel="stylesheet" href="css/jbossorg.css" type="text/css"/>
      <meta name="generator" content="DocBook XSL Stylesheets V1.72.0"/>
      <link rel="start" href="index.html" title="JBoss AOP - User Guide"/>
      <link rel="up" href="testing.html" title="Chapter 8. Testing with AOP"/>
      <link rel="prev" href="testing.html" title="Chapter 8. Testing with AOP"/>
      <link rel="next" href="testing1.html" title="8.2. Injecting Mock Objects"/>
   </head>
   <body>
      <p id="title">
         <a href="http://www.jboss.org" class="jbossOrg_href">
            <strong>
						        JBoss.org	
						</strong>
         </a>
         <a href="http://labs.jboss.com/projects/docs" class="commDoc_href">
            <strong>
						        Community Documentation	
						</strong>
         </a>
      </p>
      <ul class="docnav">
         <li class="previous">
            <a accesskey="p" href="testing.html">
               <strong>Prev</strong>
            </a>
         </li>
         <li class="next">
            <a accesskey="n" href="testing1.html">
               <strong>Next</strong>
            </a>
         </li>
      </ul>
      <div class="sect1" lang="en">
         <div class="titlepage">
            <div>
               <div>
                  <h2 class="title">
                     <a id="exception"/>8.1. Testing Exception Handling</h2>
               </div>
            </div>
         </div>
         <p>
         The sign of a well design application is how gracefully it can handle errors.  To be able to handle errors
         gracefully in all circumstances though requires lots and lots of testing.  You have to test that your application
         is catching and handling exceptions carefully.  Sometimes its hard to produce error conditions because your
         code is interacting with a third party library, or third party service like a database or something.  You can
         write complex mock objects in these scenarios, but let's see how you can create these error conditions in an
         easier and more flexible way with JBoss AOP.
      </p>
         <p>
         The example scenario we'll give is an application that needs to be tested on whether or not it handles an
         Oracle database deadlock exception gracefully.  What we'll do is write an advice that intercepts calls
         to <code class="literal">java.sql.Statement</code> execute methods and always throw a SQLException with the appropriate
         deadlock error code.
      </p>
         <pre class="programlisting">public class SQLDeadlockExceptionInjector
{
   public Object throwDeadlock(Invocation invocation) throws Throwable
   {
      throw new SQLException("Oracle Deadlock", "RETRY", ORACLE_DEADLOCK_CODE);
   }
}</pre>
         <p>
         What's great about the JBoss AOP approach to testing exception handling is that you can use it on a live system
         and change how your tests run by deploying and/or undeploying certain aspects at runtime during your automatic testing
         phase.  Let's apply this aspect.
      </p>
         <pre class="programlisting">&lt;aspect class="SQLDeadlockExceptionInjector/&gt;
&lt;bind pointcut="call(* $instanceof{java.sql.Statement}-&gt;execute*(..))"&gt;
   &lt;advice name="throwDeadlock" aspect="SQLDeadlockExceptionInjector"/&gt;
&lt;/bind&gt;</pre>
         <p>
         So, the above binding will throw a deadlock exception every time an execute method of a Statement is invoked.
         This example is a bit limited though.  Maybe not all code paths can handle deadlock exceptions, or they
         should not handle deadlock exceptions and just rollback and such.  The pointcut expression language allows
         you to do more fine grain application of this particular exception aspect.  Let's say that only our
         BankAccount class is designed to successfully recover from a Oracle deadlock exception.  We can change the
         pointcut expression to be as follows:
      </p>
         <pre class="programlisting">&lt;bind pointcut="call(* $instanceof{java.sql.Statement}-&gt;execute*(..)) AND /
                                                           within(BankAccount)"&gt;
   &lt;advice name="throwDeadlock" aspect="SQLDeadlockExceptionInjector"/&gt;
&lt;/bind&gt;</pre>
         <p>
         The difference in this expression is the <code class="literal">within</code>.  It is saying that any call to execute
         methods that are within the BankAccount class.  We can even get more fine grained than that.  We can even
         specify which methods within BankAccount the exception aspect should be applied to.
      </p>
         <pre class="programlisting">&lt;bind pointcut="call(* $instanceof{java.sql.Statement}-&gt;execute*(..)) AND /
                                                  withincode(void BankAccount-&gt;withdraw(double))"&gt;
   &lt;advice name="throwDeadlock" aspect="SQLDeadlockExceptionInjector"/&gt;
&lt;/bind&gt;</pre>
         <p>
         In the above listing the <code class="literal">withincode</code> keyword specificies to match the calling of any execute
         method that is invoked within the <code class="literal">BankAccount.withdraw()</code> method.
      </p>
         <p>
         AOP gives you a lot of flexibilty in testing error conditions, JBoss AOP in particular.  Because JBoss AOP
         allows you to hotdeploy (deploy/undeploy) aspects at runtime it is very easy to integrate these types of tests
         into a live system instead of having to go through the pain of writing complex mock objects and running your
         applications outside of the application server environment.
      </p>
      </div>
      <ul class="docnav">
         <li class="previous">
            <a accesskey="p" href="testing.html">
               <strong>Prev</strong>Chapter 8. Testing with AOP</a>
         </li>
         <li class="up">
            <a accesskey="u" href="#">
               <strong>Top of page</strong>
            </a>
         </li>
         <li class="home">
            <a accesskey="h" href="index.html">
               <strong>Front page</strong>
            </a>
         </li>
         <li class="next">
            <a accesskey="n" href="testing1.html">
               <strong>Next</strong>8.2. Injecting Mock Objects</a>
         </li>
      </ul>
   </body>
</html>